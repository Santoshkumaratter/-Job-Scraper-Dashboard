{% extends 'base.html' %}

{% block title %}Jobs Listing{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-briefcase"></i> Scraped Jobs</h1>
            <p class="text-muted">Total: {{ total_jobs }} jobs</p>
        </div>
        <div>
            <a href="{% url 'export_jobs' %}" class="btn btn-success me-2">
                <i class="fas fa-download"></i> Download CSV
            </a>
            <button onclick="deleteAllJobs()" class="btn btn-danger">
                <i class="fas fa-trash-alt"></i> Delete All Jobs
            </button>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="filter-section">
    <form method="get" class="row g-3">
        <div class="col-md-4">
            <label class="form-label">Search Company</label>
            <input type="text" class="form-control" name="company" placeholder="Company name" value="{{ request.GET.company }}">
        </div>
        <div class="col-md-3">
            <label class="form-label">Market</label>
            <select class="form-control" name="market">
                <option value="">All Markets</option>
                <option value="USA" {% if request.GET.market == 'USA' %}selected{% endif %}>USA</option>
                <option value="UK" {% if request.GET.market == 'UK' %}selected{% endif %}>UK</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-search"></i> Search
            </button>
        </div>
        <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <a href="{% url 'jobs_page' %}" class="btn btn-secondary w-100">
                <i class="fas fa-times"></i> Clear
            </a>
        </div>
    </form>
</div>

<!-- Jobs Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-sm" style="font-size: 0.85rem;">
                <thead style="background-color: #4a5568; color: white;">
                    <tr>
                        <th style="min-width: 50px;">Sr. No.</th>
                        <th style="min-width: 80px;">Field</th>
                        <th style="min-width: 100px;">Posted Date</th>
                        <th style="min-width: 200px;">Job Title</th>
                        <th style="min-width: 150px;">Company</th>
                        <th style="min-width: 70px; text-align: center;">Company URL</th>
                        <th style="min-width: 100px;">Company Size</th>
                        <th style="min-width: 70px; text-align: center;">Job Link</th>
                        <th style="min-width: 100px;">Job Portal</th>
                        <th style="min-width: 120px;">Location</th>
                        <th style="min-width: 50px; text-align: center;">A</th>
                        <th style="min-width: 80px; text-align: center;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job_data in jobs_data %}
                        <tr style="background-color: {% cycle '#f9fafb' 'white' %};">
                            <td><strong>{{ job_data.sr_no }}</strong></td>
                            <td>
                                {% if job_data.job.job_type == 'REMOTE' %}
                                <span class="badge" style="background-color: #10b981; color: white; font-size: 0.75rem;">REMOTE</span>
                                {% elif job_data.job.job_type == 'FULL_TIME' %}
                                <span class="badge" style="background-color: #3b82f6; color: white; font-size: 0.75rem;">FULL TIME</span>
                                {% elif job_data.job.job_type == 'FREELANCE' %}
                                <span class="badge" style="background-color: #f59e0b; color: white; font-size: 0.75rem;">FREELANCE</span>
                                {% elif job_data.job.job_type == 'HYBRID' %}
                                <span class="badge" style="background-color: #8b5cf6; color: white; font-size: 0.75rem;">HYBRID</span>
                                {% elif job_data.job.job_type == 'PART_TIME' %}
                                <span class="badge" style="background-color: #ec4899; color: white; font-size: 0.75rem;">PART TIME</span>
                                {% else %}
                                <span class="badge" style="background-color: #6b7280; color: white; font-size: 0.75rem;">{{ job_data.job.job_type|default:"OTHER" }}</span>
                                {% endif %}
                            </td>
                            <td>{{ job_data.job.posted_date|date:"m/d/Y"|default:"-" }}</td>
                            <td><strong>{{ job_data.job.job_title }}</strong></td>
                            <td>{{ job_data.job.company }}</td>
                            <td style="text-align: center;">
                                {% if job_data.job.company_url %}
                                <a href="{{ job_data.job.company_url }}" target="_blank" title="{{ job_data.job.company_url }}">
                                    <i class="fas fa-external-link-alt" style="color: #3b82f6;"></i>
                                </a>
                                {% else %}-{% endif %}
                            </td>
                            <td>{{ job_data.job.get_company_size_display|default:"-" }}</td>
                            <td style="text-align: center;">
                                <a href="{{ job_data.job.job_link }}" target="_blank" title="View Job Posting">
                                    <i class="fas fa-external-link-alt" style="color: #10b981;"></i>
                                </a>
                            </td>
                            <td>{{ job_data.job.source_job_portal.name|default:"-" }}</td>
                            <td>{{ job_data.job.location|default:"-" }}</td>
                            
                            <td style="text-align: center;">
                                <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#jobModal{{ job_data.job.id }}" title="View Details" style="padding: 2px 6px;">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </td>
                            <td style="text-align: center;">
                                <button onclick="deleteJob({{ job_data.job.id }}, '{{ job_data.job.job_title|escapejs }}')" class="btn btn-sm btn-danger" title="Delete Job" style="padding: 2px 6px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    
                    <!-- Job Details Modal -->
                    <div class="modal fade" id="jobModal{{ job_data.job.id }}" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">{{ job_data.job.job_title }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p><strong>Company:</strong> {{ job_data.job.company }}</p>
                                    <p><strong>Location:</strong> {{ job_data.job.location }}</p>
                                    <p><strong>Market:</strong> {{ job_data.job.market }}</p>
                                    <p><strong>Company Size:</strong> {{ job_data.job.get_company_size_display }}</p>
                                    <p><strong>Job Type:</strong> {{ job_data.job.job_type|default:"Not specified" }}</p>
                                    <p><strong>Posted Date:</strong> {{ job_data.job.posted_date|date:"F d, Y"|default:"Not specified" }}</p>
                                    <p><strong>Source:</strong> {{ job_data.job.source_job_portal.name|default:"-" }}</p>
                                    
                                    <hr>
                                    
                                    <p><strong>Job Link:</strong> <a href="{{ job_data.job.job_link }}" target="_blank">{{ job_data.job.job_link }}</a></p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <a href="{{ job_data.job.job_link }}" target="_blank" class="btn btn-primary">View Full Job</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <tr>
                        <td colspan="12" class="text-center text-muted py-5">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>No jobs found. Start scraping by creating and running a filter!</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if paginator.num_pages > 1 %}
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ total_jobs }} jobs
            </div>
            <nav>
                <ul class="pagination mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if request.GET.company %}&company={{ request.GET.company }}{% endif %}{% if request.GET.market %}&market={{ request.GET.market }}{% endif %}">First</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.company %}&company={{ request.GET.company }}{% endif %}{% if request.GET.market %}&market={{ request.GET.market }}{% endif %}">Previous</a>
                    </li>
                    {% endif %}
                    
                    {% for num in paginator.page_range %}
                        {% if page_obj.number == num %}
                        <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item"><a class="page-link" href="?page={{ num }}{% if request.GET.company %}&company={{ request.GET.company }}{% endif %}{% if request.GET.market %}&market={{ request.GET.market }}{% endif %}">{{ num }}</a></li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.company %}&company={{ request.GET.company }}{% endif %}{% if request.GET.market %}&market={{ request.GET.market }}{% endif %}">Next</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ paginator.num_pages }}{% if request.GET.company %}&company={{ request.GET.company }}{% endif %}{% if request.GET.market %}&market={{ request.GET.market }}{% endif %}">Last</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function deleteJob(jobId, jobTitle) {
    if (confirm(`Are you sure you want to delete this job?\n\n"${jobTitle}"\n\nThis action cannot be undone.`)) {
        // Show loading state
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        // Navigate to delete URL
        window.location.href = '/jobs/' + jobId + '/delete/?page={{ page_obj.number }}';
    }
}

function deleteAllJobs() {
    const totalJobs = {{ total_jobs }};
    
    if (confirm(`⚠️ WARNING: This will permanently delete ALL ${totalJobs} jobs!\n\nThis action cannot be undone.\n\nAre you absolutely sure?`)) {
        if (confirm(`Final confirmation: Delete ALL ${totalJobs} jobs?`)) {
            // Show loading overlay
            const overlay = document.createElement('div');
            overlay.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 40px; border-radius: 15px; text-align: center;">
                        <div class="spinner-border text-danger mb-3" style="width: 3rem; height: 3rem;"></div>
                        <h4>Deleting All Jobs...</h4>
                        <p class="text-muted">Please wait...</p>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            
            // Navigate to delete all URL
            window.location.href = '/jobs/delete-all/';
        }
    }
}
</script>
<script>
// Live stream: append new jobs as they are saved
(function(){
    const tbody = document.querySelector('table tbody');
    if (!tbody) return;
    let lastTs = new Date().toISOString(); // start now; only append newer jobs
    let srNo = {{ page_obj.end_index|default:0 }}; // continue numbering
    const badge = (type) => {
        switch(type){
            case 'REMOTE': return '<span class="badge" style="background-color:#10b981;color:#fff;font-size:0.75rem;">REMOTE</span>';
            case 'FULL_TIME': return '<span class="badge" style="background-color:#3b82f6;color:#fff;font-size:0.75rem;">FULL TIME</span>';
            case 'FREELANCE': return '<span class="badge" style="background-color:#f59e0b;color:#fff;font-size:0.75rem;">FREELANCE</span>';
            case 'HYBRID': return '<span class="badge" style="background-color:#8b5cf6;color:#fff;font-size:0.75rem;">HYBRID</span>';
            case 'PART_TIME': return '<span class="badge" style="background-color:#ec4899;color:#fff;font-size:0.75rem;">PART TIME</span>';
            case 'UNKNOWN': return '<span class="badge" style="background-color:#6b7280;color:#fff;font-size:0.75rem;">UNKNOWN</span>';
            default: return '<span class="badge" style="background-color:#6b7280;color:#fff;font-size:0.75rem;">OTHER</span>';
        }
    };
    function htmlEscape(s){return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));}
    async function poll(){
        try{
            const res = await fetch(`/api/jobs/stream/?after=${encodeURIComponent(lastTs)}&limit=200`);
            if(!res.ok) return;
            const data = await res.json();
            if(Array.isArray(data) && data.length){
                data.forEach(j => {
                    srNo += 1;
                    // update lastTs to the latest scraped_at
                    if (j.scraped_at) { lastTs = j.scraped_at; }
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${srNo}</strong></td>
                        <td>${badge(j.job_type)}</td>
                        <td>${j.posted_date || '-'}</td>
                        <td><strong>${htmlEscape(j.job_title)}</strong></td>
                        <td>${htmlEscape(j.company)}</td>
                        <td style="text-align:center;">${j.company_url ? `<a href="${j.company_url}" target="_blank"><i class=\"fas fa-external-link-alt\" style=\"color:#3b82f6;\"></i></a>` : '-'}</td>
                        <td>${j.company_size_display || '-'}</td>
                        <td style="text-align:center;"><a href="${j.job_link}" target="_blank"><i class="fas fa-external-link-alt" style="color:#10b981;"></i></a></td>
                        <td>${j.source_portal || '-'}</td>
                        <td>${htmlEscape(j.location || '-')}
                        </td>
                        <td style="text-align:center;"><span class="text-muted">-</span></td>
                        <td style="text-align:center;"><span class="text-muted">-</span></td>`;
                    tbody.prepend(tr); // show newest first
                });
                // update total counter
                const totalP = document.querySelector('.page-header p.text-muted');
                if (totalP){
                    const m = totalP.textContent.match(/\d+/);
                    const current = m ? parseInt(m[0],10) : 0;
                    totalP.textContent = `Total: ${current + data.length} jobs`;
                }
            }
        }catch(e){ /* ignore */ }
        setTimeout(poll, 1000);
    }
    setTimeout(poll, 1000);
})();
</script>
{% endblock %}

